version: '2'
services:
  proxy:
    image: jwilder/nginx-proxy
    environment:
      DEFAULT_HOST: pacman.${RIT_ENV}.rit.unimaas.nl
      # otherwise logstash will keep sending its own logs to itself over and over
      LOGSPOUT: ignore
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/ssl/certs:/etc/nginx/certs/
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - corpus_default
      - oculus_default
      - default
  elk:
    build: elk/
    hostname: elk
    environment:
      ELASTIC_PASSWORD : foobar
      # otherwise logstash will keep sending its own logs to itself over and over
      LOGSPOUT: ignore
      VIRTUAL_HOST: elk.${RIT_ENV}.rit.unimaas.nl
    ports:
      # Expose Filebeat-ELK-port that accepts logs from non-Docker services
      - "5044:5044"
    volumes:
      - /etc/localtime:/etc/localtime:ro
  elastalert:
    build: elastalert/
    hostname: elastalert
    environment:
      SET_CONTAINER_TIMEZONE: "True" #Set to "True" (without quotes) to set the timezone when starting a container. Default is False
      CONTAINER_TIMEZONE: Europe/Amsterdam
      ELASTICSEARCH_HOST: elk
      ELASTICSEARCH_PORT: 9200 #Defaults to 9200.
      ELASTICSEARCH_USER: elastic
      ELASTICSEARCH_PASSWORD: foobar
#      ELASTICSEARCH_TLS - Use HTTPS when connecting to Elasticsearch (True/False). Default is False.
#      ELASTICSEARCH_TLS_VERIFY - Verify server (Elasticsearch) certificate (True/False). Default is False.
#      ELASTALERT_INDEX - Name of Elastalert writeback index in Elasticseach. Defaults to elastalert_status.
    volumes:
      - elastalertdata:/opt/logs
      - ./elastalert/config:/opt/config
      - ./elastalert/rules:/opt/rules
  logspout:
    build: logspout/
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - "elk"
    environment:
      DEBUG: "true"
      LOGSPOUT: ignore
    command: "logstash://elk:5000"

networks:
  corpus_default:
    external: true
  oculus_default:
    external: true

volumes:
  elastalertdata:
