version: '2'
services:
  proxy:
    image: jwilder/nginx-proxy
    environment:
      DEFAULT_HOST: pacman.${RIT_ENV}.rit.unimaas.nl
      # otherwise logstash will keep sending its own logs to itself over and over
      LOGSPOUT: ignore
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/ssl/certs:/etc/nginx/certs/
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
    networks:
      - corpus_default
      - oculus_default
      - default
  elk:
    build: elk/
    hostname: elk
    environment:
      ELASTIC_PASSWORD : foobar
      # otherwise logstash will keep sending its own logs to itself over and over
      LOGSPOUT: ignore
      VIRTUAL_HOST: elk.${RIT_ENV}.rit.unimaas.nl
    ports:
      # Expose Filebeat-ELK-port that accepts logs from non-Docker services
      - "5044:5044"
    volumes:
      - /etc/localtime:/etc/localtime:ro
  logspout:
    build: logspout/
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - "elk"
    environment:
      DEBUG: "true"
      LOGSPOUT: ignore
    command: "logstash://elk:5000"
  nagios:
    build: externals/nagios-docker/
    hostname: nagios
    environment:
      LOGSTASH_TAG: NAGIOS
      VIRTUAL_HOST: nagios.${RIT_ENV}.rit.unimaas.nl
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./externals/nagios-docker/cust-plugins:/opt/Custom-Nagios-Plugins:ro
      - ./externals/nagios-docker/etc:/opt/nagios/etc:ro
      - ./externals/nagios-docker/etc/htpasswd.users:/opt/nagios/etc/htpasswd.users
      - nagiosdata:/opt/nagios/var
  rabbitmq:
    image: rabbitmq:3-management
    hostname: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER : user
      RABBITMQ_DEFAULT_PASS : password
    ports:
      - "8888:15672"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - rabbitmq:/var/lib/rabbitmq
  mailer:
    build: externals/dh-mailer
    hostname: mailer
    environment:
      HTTP_AUTH_USERNAME : user
      HTTP_AUTH_PASSWORD : password
      RABBITMQ_HOST : rabbitmq
      RABBITMQ_USER : user
      RABBITMQ_PASS : password
      TRANSPORT : "stub"
      BCC : "false"
      MICROSERVICE_PORT : 80
      DEFAULT_FROM : "DataHub [mailer] <datahub@maastrichtuniversity.nl>"
      SMTP_HOST : "smtp.maastrichtuniversity.nl"
      SMTP_PORT : 25
      TEMPLATES_DIR : "/usr/src/app/templates"
      PARALLELL_WORKERS : 3
      MICROSECONDS_BETWEEN_PULLS : 60000
      LOG_LEVEL_CONSOLE : 'debug'
      LOG_LEVEL_FILE : 'info'
      LOGSTASH_TAGS: MAILER
      VIRTUAL_HOST: mailer.${RIT_ENV}.rit.unimaas.nl
    restart: on-failure
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./externals/dh-mailer/app:/usr/src/app/
    networks:
      - oculus_default
      - corpus_default
      - default
networks:
  corpus_default:
    external: true
  oculus_default:
    external: true

volumes:
  nagiosdata:
  rabbitmq:
