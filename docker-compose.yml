version: '2'
services:
  proxy:
    image: jwilder/nginx-proxy
    environment:
      DEFAULT_HOST: pacman.${RIT_ENV}.rit.unimaas.nl
      # otherwise logstash will keep sending its own logs to itself over and over
      LOGSPOUT: ignore
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/ssl/certs:/etc/nginx/certs/
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - ./proxy/client_max_body_size.conf:/etc/nginx/conf.d/client_max_body_size.conf:ro
    networks:
      - corpus_default
      - oculus_default
      - default
  elk:
    build: elk/
    hostname: elk
    environment:
      ELASTIC_PASSWORD : foobar
      # otherwise logstash will keep sending its own logs to itself over and over
      LOGSPOUT: ignore
      VIRTUAL_HOST: elk.${RIT_ENV}.rit.unimaas.nl
    ports:
      # Expose Filebeat-ELK-port that accepts logs from non-Docker services
      - "5044:5044"
      # Expose Logstash-HTTP-port that accepts logs from non-Docker services
      - "5001:5001"
    volumes:
      - /etc/localtime:/etc/localtime:ro
  elastalert:
    build: externals/elastalert-docker/
    hostname: elastalert
    environment:
      SET_CONTAINER_TIMEZONE: "True" #Set to "True" (without quotes) to set the timezone when starting a container. Default is False
      CONTAINER_TIMEZONE: Europe/Amsterdam
      ELASTICSEARCH_HOST: elk
      ELASTICSEARCH_PORT: 9200 #Defaults to 9200.
      ELASTICSEARCH_USER: elastic
      ELASTICSEARCH_PASSWORD: foobar
      LOGSPOUT: ignore
#      ELASTICSEARCH_TLS - Use HTTPS when connecting to Elasticsearch (True/False). Default is False.
#      ELASTICSEARCH_TLS_VERIFY - Verify server (Elasticsearch) certificate (True/False). Default is False.
#      ELASTALERT_INDEX - Name of Elastalert writeback index in Elasticseach. Defaults to elastalert_status.
    volumes:
      - elastalertdata:/opt/logs
      - ./externals/elastalert-docker/config:/opt/config
      - ./externals/elastalert-docker/rules:/opt/rules
      - ./externals/elastalert-docker/custom_alerts.py:/opt/elastalert/custom_alerts.py
  logspout:
    build: logspout/
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - "elk"
    environment:
      DEBUG: "true"
      LOGSPOUT: ignore
      MULTILINE_ENABLE_DEFAULT: "true"
      MULTILINE_MATCH: "nonfirst"
      MULTILINE_PATTERN: '^(\s|{)'
      MULTILINE_FLUSH_AFTER: 500
    command: "multiline+logstash://elk:5000"
  nagios:
    build: externals/nagios-docker/
    hostname: nagios
    environment:
      NAGIOS_FQDN: nagios.${RIT_ENV}.rit.unimaas.nl
      MAILER_MICROSERVICE_HOST: mailer.${RIT_ENV}.rit.unimaas.nl
      MAILER_MICROSERVICE_USER: user
      MAILER_MICROSERVICE_PASS: password
      LOGSTASH_TAGS: NAGIOS, AUX
      VIRTUAL_HOST: nagios.${RIT_ENV}.rit.unimaas.nl
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./externals/nagios-docker/cust-plugins:/opt/Custom-Nagios-Plugins:ro
      - ./externals/nagios-docker/etc:/opt/nagios/etc:ro
      - ./externals/nagios-docker/etc/htpasswd.users:/opt/nagios/etc/htpasswd.users
      - nagiosdata:/opt/nagios/var
      - ./.pgpass:/opt/nagios/.pgpass:ro
    networks:
      - corpus_default
      - oculus_default
      - imago_default
      - default
  rabbitmq:
    build: rabbitmq/
    hostname: rabbitmq
    environment:
      # Note that changing the default username and password through these ENV vars does not work when the named volume 'rabbitmq' already exists.
      # Username and password are stored in a credentials file somewhere inside the /var/lib/rabbitmq folder (thus within the named volume)
      # In such cases, changing the username and password can only be achieved by 1) doing it through the rabbitmq management web interface
      # or 2) by deleting the named volume, updating the ENV vars and recreating the Docker container.
      LOGSTASH_TAGS: RABBITMQ
      VIRTUAL_HOST: rabbitmq.${RIT_ENV}.rit.unimaas.nl
      VIRTUAL_PORT: 15672
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - rabbitmq:/var/lib/rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
  mailer:
    build: externals/dh-mailer
    hostname: mailer
    environment:
      HTTP_AUTH_USERNAME : user
      HTTP_AUTH_PASSWORD : password
      RABBITMQ_HOST : rabbitmq
      RABBITMQ_USER : user
      RABBITMQ_PASS : password
      TRANSPORT : "stub"
      BCC : "false"
      MICROSERVICE_PORT : 80
      DEFAULT_FROM : "DataHub [mailer] <datahub@maastrichtuniversity.nl>"
      SMTP_HOST : "smtp.maastrichtuniversity.nl"
      SMTP_PORT : 25
      TEMPLATES_DIR : "/usr/src/app/templates"
      # Send 1 message every 1000 milliseconds
      CHANNEL_PREFETCH : 1
      MS_BETWEEN_PULLS : 1000
      LOG_LEVEL_CONSOLE : 'info'
      LOG_LEVEL_FILE : 'debug'
      LOGSTASH_TAGS: MAILER
      VIRTUAL_HOST: mailer.${RIT_ENV}.rit.unimaas.nl
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./externals/dh-mailer/app:/usr/src/app/
    networks:
      - oculus_default
      - corpus_default
      - default
#  pg_backup_xnat:
#    image: martianrock/pg_backup_rotated
#    hostname: pg_backup_xnat
#    environment:
#      POSTGRES_HOSTNAME: xnat-db
#      POSTGRES_USER: xnat
#      POSTGRES_PASSWORD: xnat
#      CRON_RUN_MINUTE: 49
#      CRON_RUN_HOUR: 9
##      WEEKS_TO_KEEP: 5
##      DAYS_TO_KEEP: 7
#      DAY_OF_WEEK_TO_KEEP: 1
#      ENABLE_GLOBALS_BACKUPS: "no"
##      ENABLE_PLAIN_BACKUPS: "yes"
#      ENABLE_CUSTOM_BACKUPS: "no"
##      SCHEMA_ONLU_LIST: ""
#    volumes:
#      - /etc/localtime:/etc/localtime:ro
#      - xnatpgbak:/backups
#    networks:
#      - imago_default
#  pg_backup_icat:
#    image: martianrock/pg_backup_rotated
#    hostname: pg_backup_irods
#    environment:
#      POSTGRES_HOSTNAME: irods-db
#      POSTGRES_USER: postgres
#      POSTGRES_PASSWORD: foobar
#      CRON_RUN_MINUTE: 48,49
#      CRON_RUN_HOUR: 9
#      DAY_OF_WEEK_TO_KEEP: 1
#      ENABLE_GLOBALS_BACKUPS: "no"
#      ENABLE_CUSTOM_BACKUPS: "no"
#    volumes:
#      - /etc/localtime:/etc/localtime:ro
#      - ./pgbaki:/backups
#    networks:
#      - corpus_default
networks:
  corpus_default:
    external: true
  oculus_default:
    external: true
  imago_default:
    external: true
volumes:
  elastalertdata:
  nagiosdata:
  rabbitmq:
  xnatpgbak:
#      driver: local
#      driver_opts:
#        type: nfs
#        device: ":/bkp/xnat-dev3"
#        o: "addr=fhml-srv017.unimaas.nl,vers=3"

