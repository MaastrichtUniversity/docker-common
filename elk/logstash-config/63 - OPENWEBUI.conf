filter {
    if "OPENWEBUI" in [tags] {

        mutate {
            add_field => { "logtrail" => "openwebui" }
            add_tag => [ "CP63_MUT01" ]
        }

        grok {
            break_on_match => true

            # HTTP access log via uvicorn
            match => { 
                "message" => "^%{TIMESTAMP_ISO8601:timestamp} \| %{LOGLEVEL:level}\s+\| %{DATA:python_module}:%{DATA:python_function}:%{NUMBER:python_line} - %{IP:remote_ip}:%{NUMBER:remote_port} - \"%{GREEDYDATA:http_message}\" %{NUMBER:response_code}" 
            }

            # Internal OpenWebUI function log
            match => { 
                "message" => "^%{TIMESTAMP_ISO8601:timestamp} \| %{LOGLEVEL:level}\s+\| %{DATA:python_module}:%{DATA:python_function}:%{NUMBER:python_line} - %{GREEDYDATA:log_message}" 
            }

            # Fallback
            match => { "message" => "%{GREEDYDATA:log_message}" }

            add_tag => [ "CP63_GRO01" ]
        }

        # For uvicorn HTTP logs, store just METHOD + URL + HTTP in log_message
        if [python_module] =~ /^uvicorn/ and [http_message] {
            mutate {
                copy => { "http_message" => "log_message" }
            }
        }

        # ECS-safe renames for HTTP logs
        mutate {
            rename => { "remote_ip" => "[source][ip]" }
            rename => { "remote_port" => "[source][port]" }
            rename => { "http_message" => "[http][raw]" } # optional
        }

        date {
            match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
            remove_field => [ "timestamp" ]
            add_tag => [ "CP63_DAT01" ]
        }
    }
}