filter {
    if "searxng" in [tags] {

        mutate {
            add_field => { "logtrail" => "searxng" }
            add_tag => [ "CP64_MUT01" ]
        }

        grok {
            break_on_match => true

            # Standard searxng python log format
            # 2026-02-25 13:43:44,919 ERROR:searx.engines: loading engine torch failed: set engine to inactive!
            match => { "message" => "^%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level}:%{DATA:python_module}: %{GREEDYDATA:log_message}" }

            # Worker log format
            # [INFO] Started worker-1
            match => { "message" => "^\[%{LOGLEVEL:level}\] %{GREEDYDATA:log_message}" }

            # Fallback
            match => { "message" => "%{GREEDYDATA:log_message}" }

            add_tag => [ "CP64_GRO01" ]
        }

        # Handle comma milliseconds (Logstash needs explicit pattern)
        date {
            match => [ "timestamp", "yyyy-MM-dd HH:mm:ss,SSS" ]
            remove_field => [ "timestamp" ]
            add_tag => [ "CP64_DAT01" ]
        }
    }
}