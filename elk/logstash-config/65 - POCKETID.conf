filter {
    if "POCKETID" in [tags] {

        mutate {
            add_field => { "logtrail" => "pocket-id" }
            add_tag => [ "CP65_MUT01" ]
        }

        grok {
            break_on_match => true

            # Standard Request log line
            # Feb 26 08:10:43 INF Request app=pocket-id version=1.14.1 status=200 method=GET ...
            match => { "message" => "^%{SYSLOGTIMESTAMP:timestamp} %{WORD:level} Request app=%{DATA:app} version=%{DATA:version} status=%{NUMBER:status} method=%{WORD:method} path=%{DATA:path} query=%{QUOTEDSTRING:query} route=%{DATA:route} ip=%{IP:remote_ip} latency=%{DATA:latency} referer=%{QUOTEDSTRING:referer} user_agent=%{QUOTEDSTRING:user_agent} body_size=%{NUMBER:body_size}" }

            # Warning with inline error before structured fields
            # Feb 26 08:10:44 WRN Request with errors: Error #01: You are not signed in ...
            match => { "message" => "^%{SYSLOGTIMESTAMP:timestamp} %{WORD:level} %{GREEDYDATA:error_message} app=%{DATA:app} version=%{DATA:version} status=%{NUMBER:status} method=%{WORD:method} path=%{DATA:path} query=%{QUOTEDSTRING:query} route=%{DATA:route} ip=%{IP:remote_ip} latency=%{DATA:latency} referer=%{QUOTEDSTRING:referer} user_agent=%{QUOTEDSTRING:user_agent} body_size=%{NUMBER:body_size}" }

            # Other warning/error lines
            # Feb 26 08:10:50 WRN Failed to get IP location app=pocket-id version=1.14.1 error="..."
            match => { "message" => "^%{SYSLOGTIMESTAMP:timestamp} %{WORD:level} %{GREEDYDATA:log_message} app=%{DATA:app} version=%{DATA:version} %{GREEDYDATA:extra_fields}" }

            # Fallback
            match => { "message" => "%{GREEDYDATA:log_message}" }

            add_tag => [ "CP65_GRO01" ]
        }

        # Pocket ID uses syslog-style timestamp without year
        date {
            match => [ "timestamp", "MMM dd HH:mm:ss" ]
            remove_field => [ "timestamp" ]
            add_tag => [ "CP65_DAT01" ]
        }
    }
}