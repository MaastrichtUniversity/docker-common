filter {
    if "POCKETID" in [tags] {

        mutate {
            add_field => { "logtrail" => "pocket-id" }
            add_tag => [ "CP65_MUT01" ]
        }

        grok {
            break_on_match => true

            # Pocket-ID HTTP / API request logs
            match => { 
                "message" => "^%{SYSLOGTIMESTAMP:timestamp} %{LOGLEVEL:level} Request app=pocket-id version=%{DATA:version} status=%{NUMBER:status} method=%{WORD:http_method} path=%{DATA:path} query=\"%{DATA:query}\" route=%{DATA:route} ip=%{IP:remote_ip} latency=%{DATA:latency} referer=\"%{DATA:referer}\" user_agent=\"%{DATA:user_agent_raw}\" body_size=%{NUMBER:body_size}" 
            }

            # Fallback â€” keep the full log line in log_message
            match => { "message" => "%{GREEDYDATA:log_message}" }

            add_tag => [ "CP65_GRO01" ]
        }

        # Copy the user_agent string into an ECS-safe field
        mutate {
            rename => { "user_agent_raw" => "[http][user_agent]" }
        }

        # Build a short log_message: METHOD + PATH + optional query + optional route
        ruby {
            code => '
                if event.get("http_method") and event.get("path")
                    msg = "#{event.get("http_method")} #{event.get("path")}"
                    q = event.get("query")
                    r = event.get("route")
                    msg += "?#{q}" if q and !q.empty? and q != "\"\""
                    msg += " route=#{r}" if r and !r.empty?
                    event.set("log_message", msg)
                end
            '
        }

        # ECS-safe renames for other fields
        mutate {
            rename => { "remote_ip" => "[source][ip]" }
            rename => { "latency" => "[http][latency]" }
            rename => { "status" => "[http][response_code]" }
            rename => { "version" => "[service][version]" }
        }

        # Convert timestamp
        date {
            match => [ "timestamp", "MMM dd HH:mm:ss" ]
            timezone => "UTC"
            remove_field => [ "timestamp" ]
            add_tag => [ "CP65_DAT01" ]
        }
    }
}