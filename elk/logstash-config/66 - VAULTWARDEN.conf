filter {
    if "VAULTWARDEN" in [tags] {

        mutate {
            add_field => { "logtrail" => "vaultwarden" }
            add_tag => [ "CP66_MUT01" ]
        }

        grok {
            break_on_match => true

            # Rocket structured log line
            # [2026-02-25 13:42:10.934][rocket::shield::shield::_][WARN] Message
            match => { "message" => "^\[%{TIMESTAMP_ISO8601:timestamp}\]\[%{DATA:rust_module}\]\[%{LOGLEVEL:level}\] %{GREEDYDATA:log_message}" }

            # Request line
            # [2026-02-25 13:45:55.661][request][INFO] GET /path
            match => { "message" => "^\[%{TIMESTAMP_ISO8601:timestamp}\]\[request\]\[%{LOGLEVEL:level}\] %{WORD:http_method} %{DATA:path}" }

            # Response line
            # [2026-02-25 15:28:43.899][response][INFO] (login) POST /identity/connect/token => 200 OK
            match => { "message" => "^\[%{TIMESTAMP_ISO8601:timestamp}\]\[response\]\[%{LOGLEVEL:level}\] \(%{DATA:response_context}\) %{WORD:http_method} %{DATA:path} => %{NUMBER:status} %{WORD:status_text}" }

            # WebSocket connection logs
            # Accepting / Closing WS connection from IP
            match => { "message" => "^\[%{TIMESTAMP_ISO8601:timestamp}\]\[%{DATA:rust_module}\]\[%{LOGLEVEL:level}\] %{WORD:ws_action} WS connection from %{IP:remote_ip}" }

            # Plain startup warnings (no timestamp)
            # [WARNING] Some message
            match => { "message" => "^\[%{LOGLEVEL:level}\] %{GREEDYDATA:log_message}" }

            # Fallback
            match => { "message" => "%{GREEDYDATA:log_message}" }

            add_tag => [ "CP66_GRO01" ]
        }

        date {
            match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
            remove_field => [ "timestamp" ]
            add_tag => [ "CP66_DAT01" ]
        }
    }
}