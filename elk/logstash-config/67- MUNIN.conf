filter {
    if "MUNIN" in [tags] {

        mutate {
            add_field => { "logtrail" => "munin" }
            add_tag => [ "CP67_MUT01" ]
        }

        grok {
            break_on_match => true

            # Standard log line
            # 2026/02/26 10:17:33 [INFO] Remaining workers: ...
            match => { "message" => "^%{YEAR}/%{MONTHNUM}/%{MONTHDAY} %{TIME:time} \[%{DATA:level}\] %{GREEDYDATA:log_message}" }

            # Fatal error line
            # 2026/02/26 10:18:01 [FATAL ERROR] Lock already exists: ...
            match => { "message" => "^%{YEAR}/%{MONTHNUM}/%{MONTHDAY} %{TIME:time} \[%{DATA:level}\] %{GREEDYDATA:error_message}" }

            # Stack trace continuation line
            # 2026/02/26 10:18:01  at /usr/share/perl5/...
            match => { "message" => "^%{YEAR}/%{MONTHNUM}/%{MONTHDAY} %{TIME:time}\s+at %{GREEDYDATA:stacktrace}" }

            # Fallback
            match => { "message" => "%{GREEDYDATA:log_message}" }

            add_tag => [ "CP67_GRO01" ]
        }

        mutate {
            add_field => { "timestamp" => "%{YEAR}/%{MONTHNUM}/%{MONTHDAY} %{time}" }
        }

        date {
            match => [ "timestamp", "yyyy/MM/dd HH:mm:ss" ]
            remove_field => [ "timestamp", "YEAR", "MONTHNUM", "MONTHDAY", "time" ]
            add_tag => [ "CP67_DAT01" ]
        }
    }
}